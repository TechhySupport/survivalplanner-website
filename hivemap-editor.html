<!DOCTYPE html>
<html>
<head>
  <!-- Point all relative URLs to the versioned HiveMap build folder that is committed to the repo -->
  <!-- NOTE: Do not use /build/... for production; that folder is typically gitignored and won't be deployed. -->
  <base href="/hivemap/">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="HiveMap Editor - Interactive Alliance Map Planning Tool">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="HiveMap Editor">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="icon" type="image/png" href="favicon.png"/>
  <title>HiveMap Editor</title>
  <link rel="manifest" href="manifest.json">
  
  <script>
  // 1) Ensure this page is NOT controlled by the root service worker
    // If a root-scoped SW is controlling, unregister it and hard-reload once.
    (function isolateServiceWorker(){
      try {
        if (!('serviceWorker' in navigator)) return;
        const needsReloadKey = '__hivemap_sw_reloaded__';
        // If a controller exists and isn't from the /build/hivemap/ scope, unregister others
        if (navigator.serviceWorker.controller) {
          const scope = navigator.serviceWorker.controller.scriptURL || '';
          const isHiveMapScope = scope.includes('/hivemap/');
          if (!isHiveMapScope && !sessionStorage.getItem(needsReloadKey)) {
            navigator.serviceWorker.getRegistrations().then(regs => {
              regs.forEach(r => {
                if (!r.scope.endsWith('/hivemap/')) {
                  r.unregister();
                }
              });
              // Mark and force a clean reload to drop old SW control
              sessionStorage.setItem(needsReloadKey, '1');
              const u = new URL(window.location.href);
              u.searchParams.set('n', Date.now());
              window.location.replace(u.toString());
            });
          }
        }
      } catch (e) { /* ignore */ }
    })();

  // 2) Normalize the hash to the expected file hint for this dedicated app
    (function normalizeHash(){
      try {
        if (!/^#file:/i.test(window.location.hash)) {
          window.location.hash = '#file:main.dart';
        }
      } catch (e) { /* ignore */ }
    })();
  </script>
</head>
<body>
  <div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-family: Arial; color: #333;">
    <img src="logo.png" alt="Logo" style="width: 64px; height: 64px; margin-bottom: 16px;">
    <div>Loading HiveMap Editor...</div>
    <div style="font-size: 12px; color: #666; margin-top: 8px;">Preparing your tactical interface</div>
  </div>

  <!-- Load the HiveMap build bootstrap from the committed HiveMap build folder (relative to base href) -->
  <script src="flutter_bootstrap.js" async></script>
  <script>
    // Show a helpful message if the bootstrap fails to load (e.g., when the /hivemap/ assets aren't deployed yet)
    setTimeout(() => {
      if (!window._flutter && !window._flutterLoader) {
        const div = document.createElement('div');
        div.style = 'position:fixed;left:50%;top:10%;transform:translateX(-50%);background:#fff3cd;color:#856404;border:1px solid #ffeeba;padding:10px 14px;border-radius:6px;font-family:Arial;font-size:13px;';
        div.textContent = 'HiveMap assets not found at /hivemap/. Deploy the Flutter web build to the /hivemap folder.';
        document.body.appendChild(div);
      }
    }, 4000);
  </script>
  <script>
    // Hide splash after first Flutter frame
    window.addEventListener('flutter-first-frame', function () {
      const loading = document.getElementById('loading');
      if (loading) loading.style.display = 'none';
    });
  </script>
</body>
</html>
